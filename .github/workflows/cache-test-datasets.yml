# Copyright (C) 2022 Roberto Rossini (roberros@uio.no)
# SPDX-License-Identifier: MIT

name: Cache test datasets

on:
  workflow_dispatch:

  workflow_call:
    outputs:
      artifact-name:
        description: "Test dataset artifact name"
        value: ${{ jobs.cache-test-datasets.outputs.cache-key }}
      cache-key:
        description: "Test dataset cache key"
        value: ${{ jobs.cache-test-datasets.outputs.cache-key }}

  push:
    branches: [ main ]
    paths: [ "cmake/FetchExternalDataset.cmake" ]

  pull_request:
    paths: [ "cmake/FetchExternalDataset.cmake" ]

defaults:
  run:
    shell: bash

env:
  FETCH_TEST_DATASET_CMAKE: cmake/FetchTestDataset.cmake
  TEST_DATASET_PATH: test/data/modle_test_data.tar.gz

jobs:
  cache-test-datasets:
    name: Cache test datasets
    runs-on: ubuntu-latest

    outputs:
      cache-key: ${{ steps.generate-cache-key.outputs.key }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Generate cache key
      id: generate-cache-key
      run: |
        key="test-dataset-${{ hashFiles( 'cmake/FetchTestDataset.cmake' ) }}"

        echo "key=$key" >> $GITHUB_OUTPUT

    - name: Cache test datasets
      id: cache-dataset
      uses: actions/cache@v3
      with:
        key: ${{ steps.generate-cache-key.outputs.key }}
        path: ${{ env.TEST_DATASET_PATH }}

    - name: Extract test dataset URL
      id: test-dataset-url
      if: steps.cache-dataset.outputs.cache-hit != 'true'
      run: |
        url="$(grep -F 'DOWNLOAD' "$FETCH_TEST_DATASET_CMAKE" | awk '{print $2}')"

        echo "url=$url" >> $GITHUB_OUTPUT

    - name: Download test dataset
      if: steps.cache-dataset.outputs.cache-hit != 'true'
      run: |
        src="${{ steps.test-dataset-url.outputs.url }}"
        dest="$TEST_DATASET_PATH"

        mkdir -p "$(dirname "$dest")"
        curl -L "$src" -o "$dest"

    - name: Upload test dataset
      uses: actions/upload-artifact@v3
      with:
        name: ${{ steps.generate-cache-key.outputs.key }}
        path: ${{ env.TEST_DATASET_PATH }}
        if-no-files-found: error
        retention-days: 1
